{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Note</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merienda:wght@300..900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merienda:wght@300..900&family=Playwrite+HU:wght@100..400&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Parkinsans:wght@300..800&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400..900&family=Satisfy&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/styles1.css' %}">
</head>
<body>
    <div class="editor-container">
        <div class="main">
            <div class="header">
                <div class="header-title">Edit Your Note: {{ user.username }}</div>
                <button type="submit" onclick="saveContent()" id="save-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="save-icon">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save Changes
                </button>
            </div>
            <div class="toolbar">
                <div class="left_section">
                    <ul class="tool_manager">
                        <li class="tools">
                            <a href="{% url 'inner_home' %}" class="tool-link">
                                <img src="{% static '/svgs/home.svg' %}" alt="" class="tool_icons" id="homee">
                            </a>
                        </li>
                        <li class="tools">
                            <button class="tool-button" onclick="document.execCommand('bold')">
                                <img src="{% static '/svgs/bold.svg' %}" alt="" class="tool_icons">
                            </button>
                        </li>
                        <li class="tools">
                            <button class="tool-button" onclick="document.execCommand('underline')">
                                <img src="{% static '/svgs/underline.svg' %}" alt="" class="tool_icons">
                            </button>
                        </li>
                        <li class="tools">
                            <button class="tool-button" onclick="document.execCommand('italic')">
                                <img src="{% static '/svgs/italic.svg' %}" alt="" class="tool_icons">
                            </button>
                        </li>
                        <li class="tools">
                            <button class="tool-button" onclick="document.execCommand('undo')">
                                <img src="{% static '/svgs/undo.svg' %}" alt="" class="tool_icons">
                            </button>
                        </li>                
                        <li class="tools" id="clear">
                            <button class="tool-button">
                                <img src="{% static '/svgs/delete.svg' %}" alt="" class="tool_icons">
                            </button>
                        </li>                
                        <li class="tools" id="fontsize">
                            <div class="select-wrapper">
                                <img src="{% static 'svgs/text.svg' %}" alt="" class="tool_icons">
                                <select id="fontSizeSelector" class="tool_icons">
                                    <option value="14px">14px</option>
                                    <option value="16px" selected>16px</option>
                                    <option value="18px">18px</option>
                                    <option value="20px">20px</option>
                                    <option value="24px">24px</option>
                                    <option value="28px">28px</option>
                                </select>
                            </div>
                        </li>
                        <li class="tools" id="colorpalleteli">
                            <div class="select-wrapper">
                                <img src="{% static 'svgs/color.svg' %}" alt="" class="tool_icons">
                                <select id="colorpallete" onchange="changeTextColor(this.value)">
                                    <option value="white">White</option>
                                    <option value="red">Red</option>
                                    <option value="blue">Blue</option>
                                    <option value="yellow">Yellow</option>
                                    <option value="green">Green</option>
                                </select>
                            </div>
                        </li>
                        <li class="tools" id="img_add">
                            <div class="image-upload">
                                <button class="tool-button">
                                    <img src="{% static '/svgs/add_img.svg' %}" alt="Upload Icon" class="tool_icons" id="img_icon">
                                </button>
                                <input type="file" id="imageInput" style="display: none;" accept="image/*">
                            </div> 
                        </li> 
                        <li class="tools" id="audio-upload">
                            <div class="audio-upload">
                                <button class="tool-button">
                                    <img id="uploadAudioIcon" src="{% static '/svgs/music.svg' %}" alt="Audio Icon">
                                </button>
                                <input type="file" id="audioInput" style="display: none;" accept="audio/*">
                            </div>
                        </li> 
                        <li class="tools" id="theme-selector">
                            <button class="tool-button" id="theme-button">
                                <img src="{% static '/svgs/palette.svg' %}" alt="Themes" class="tool_icons">
                            </button>
                            <div class="theme-dropdown" id="theme-dropdown">
                                <div class="theme-option" data-theme="default">
                                    <div class="theme-preview" style="background-image: url('{% static '/themes/default.jpg' %}')"></div>
                                    <span>Serenity Bloom</span>
                                </div>
                                <div class="theme-option" data-theme="nature">
                                    <div class="theme-preview" style="background-image: url('{% static '/themes/nature.jpg' %}')"></div>
                                    <span>Urban Haze</span>
                                </div>
                                <div class="theme-option" data-theme="abstract">
                                    <div class="theme-preview" style="background-image: url('{% static '/themes/abstract.jpg' %}')"></div>
                                    <span>Skyline Swing</span>
                                </div>
                                <div class="theme-option" data-theme="minimal">
                                    <div class="theme-preview" style="background-image: url('{% static '/themes/minimal.jpg' %}')"></div>
                                    <span>Celestial Drift</span>
                                </div>
                                <div class="theme-option" data-theme="love">
                                    <div class="theme-preview" style="background-image: url('{% static '/themes/love.jpg' %}')"></div>
                                    <span>Starry Night</span>
                                </div>
                            </div>
                        </li>
                        <li class="tools" id="font-selector">
                            <button class="tool-button" id="font-button">
                                <img src="{% static '/svgs/font.svg' %}" alt="Fonts" class="tool_icons">
                            </button>
                            <div class="font-dropdown" id="font-dropdown">
                                <div class="font-option" data-font="'Satisfy', cursive">
                                    <span style="font-family: 'Satisfy', cursive;">Satisfy</span>
                                </div>
                                <div class="font-option" data-font="'Arial', sans-serif">
                                    <span style="font-family: 'Arial', sans-serif;">Arial</span>
                                </div>
                                <div class="font-option" data-font="'Times New Roman', serif">
                                    <span style="font-family: 'Times New Roman', serif;">Times New Roman</span>
                                </div>
                                <div class="font-option" data-font="'Courier New', monospace">
                                    <span style="font-family: 'Courier New', monospace;">Courier New</span>
                                </div>
                                <div class="font-option" data-font="'Georgia', serif">
                                    <span style="font-family: 'Georgia', serif;">Georgia</span>
                                </div>
                                <div class="font-option" data-font="'Verdana', sans-serif">
                                    <span style="font-family: 'Verdana', sans-serif;">Verdana</span>
                                </div>
                                <div class="font-option" data-font="'Pacifico', cursive">
                                    <span style="font-family: 'Pacifico', cursive;">Pacifico</span>
                                </div>
                                <div class="font-option" data-font="'Roboto', sans-serif">
                                    <span style="font-family: 'Roboto', sans-serif;">Roboto</span>
                                </div>
                                <div class="font-option" data-font="'Open Sans', sans-serif">
                                    <span style="font-family: 'Open Sans', sans-serif;">Open Sans</span>
                                </div>
                                <div class="font-option" data-font="'Lato', sans-serif">
                                    <span style="font-family: 'Lato', sans-serif;">Lato</span>
                                </div>
                            </div>
                        </li>
                        <li class="tool-button" id="speechButton">
                            <img src="{% static '/svgs/voice.svg' %}" alt="Fonts" class="tool_icons">
                          </li>
                    </ul>
                </div>
            </div>
        
            <div class="editor-content">
                <div class="bg" data-theme="{{ note.theme }}">
                    <div class="editable-div" id="message" name="message" placeholder="Edit your note" required>
                        <!-- Form to edit the note -->
                        <form method="POST" action="{% url 'edit_note' note.id %}" id="note-form">
                            {% csrf_token %}
                            {{ form.as_p }}
                            
                            <!-- Title -->
                            <div id="title" contenteditable="true" spellcheck="false">
                                {{ note.title|safe }}
                            </div>
                            <input type="hidden" id="note-title" name="title">
                            
                            <!-- Content -->
                            <div id="normal" contenteditable="true" spellcheck="false">
                                {{ note.content|safe }} <!-- Pre-fill the content -->
                            </div>
                            <input type="hidden" id="note-content" name="content">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="speechModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Voice to Text</h3>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <div class="recording-controls">
              <button id="startRecord">Start Recording</button>
              <button id="stopRecord" disabled>Stop Recording</button>
              <div class="recording-status" id="recordingStatus" style="display:none;">
                <div class="recording-indicator"></div>
                <span>Recording...</span>
              </div>
            </div>
            <div id="transcriptBox" contenteditable="true" placeholder="Your speech will appear here..."></div>
            <button id="insertText">Insert into Note</button>
          </div>
        </div>
      </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Theme selector functionality
            const themeButton = document.getElementById("theme-button");
            const themeDropdown = document.getElementById("theme-dropdown");
          
            if (themeButton && themeDropdown) {
              // Toggle theme dropdown
              themeButton.addEventListener("click", (e) => {
                e.stopPropagation();
                themeDropdown.style.display = themeDropdown.style.display === "block" ? "none" : "block";
              });
          
              // Close dropdown when clicking outside
              document.addEventListener("click", () => {
                if (themeDropdown) {
                  themeDropdown.style.display = "none";
                }
              });
          
              // Prevent dropdown from closing when clicking inside it
              themeDropdown.addEventListener("click", (e) => {
                e.stopPropagation();
              });
          
              // Handle theme selection
              const themeOptions = document.querySelectorAll(".theme-option");
              themeOptions.forEach((option) => {
                option.addEventListener("click", function () {
                  const theme = this.getAttribute("data-theme");
                  const bgElement = document.querySelector(".bg");
                  if (bgElement) {
                    bgElement.setAttribute("data-theme", theme);
                    themeDropdown.style.display = "none";
                  }
                });
              });
            }
          
            // Connect file inputs to their buttons
            document.getElementById('img_icon').addEventListener('click', function() {
              document.getElementById('imageInput').click();
            });
            
            document.getElementById('uploadAudioIcon').addEventListener('click', function() {
              document.getElementById('audioInput').click();
            });
            
            // Handle image upload
            document.getElementById('imageInput').addEventListener('change', function(e) {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                  const img = document.createElement('img');
                  img.src = event.target.result;
                  img.style.maxWidth = '100%';
                  document.getElementById('normal').appendChild(img);
                };
                reader.readAsDataURL(file);
              }
            });
            
            // Handle font size changes
            document.getElementById('fontSizeSelector').addEventListener('change', function() {
              document.execCommand('fontSize', false, '7');
              const fontElements = document.getElementsByTagName('font');
              for (let i = 0; i < fontElements.length; i++) {
                if (fontElements[i].size === '7') {
                  fontElements[i].removeAttribute('size');
                  fontElements[i].style.fontSize = this.value;
                }
              }
            });
            
            // Connect save button to form submission
            document.getElementById('save-button').addEventListener('click', function(e) {
              e.preventDefault();
              saveContent();
              document.getElementById('note-form').submit();
            });
            
            // Clear button functionality
            document.getElementById('clear').addEventListener('click', function() {
              if (confirm('Are you sure you want to clear the content?')) {
                document.getElementById('normal').innerHTML = '';
              }
            });
          
            // Font dropdown functionality
            const fontButton = document.getElementById('font-button');
            const fontDropdown = document.getElementById('font-dropdown');
            const fontOptions = document.querySelectorAll('.font-option');
            
            // Toggle font dropdown
            if (fontButton && fontDropdown) {
              fontButton.addEventListener('click', function(e) {
                e.stopPropagation();
                fontDropdown.classList.toggle('active');
                
                // Close theme dropdown if open
                const themeDropdown = document.getElementById('theme-dropdown');
                if (themeDropdown && themeDropdown.classList.contains('active')) {
                  themeDropdown.classList.remove('active');
                }
              });
            }
            
            // Font selection
            fontOptions.forEach(option => {
              option.addEventListener('click', function() {
                const selectedFont = this.getAttribute('data-font');
                
                // Apply font to selected text
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                  const range = selection.getRangeAt(0);
                  if (!range.collapsed) {
                    // Text is selected, apply font to selection
                    const span = document.createElement('span');
                    span.style.fontFamily = selectedFont;
                    range.surroundContents(span);
                  } else {
                    // No text selected, apply to editable div for future typing
                    const editable = document.querySelector('.editable-div');
                    if (editable) {
                      editable.style.fontFamily = selectedFont;
                    }
                  }
                } else {
                  // Fallback - apply to whole content
                  const editable = document.querySelector('.editable-div');
                  if (editable) {
                    editable.style.fontFamily = selectedFont;
                  }
                }
                
                // Close dropdown after selection
                if (fontDropdown) {
                  fontDropdown.classList.remove('active');
                }
              });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
              if (fontButton && fontDropdown && !fontButton.contains(e.target) && !fontDropdown.contains(e.target)) {
                fontDropdown.classList.remove('active');
              }
            });
          
            // Speech to text functionality
            let mediaRecorder, audioChunks = [];
            const speechButton = document.getElementById('speechButton');
            const speechModal = document.getElementById('speechModal');
            const closeButton = document.querySelector('.close');
            const startRecord = document.getElementById('startRecord');
            const stopRecord = document.getElementById('stopRecord');
            const transcriptBox = document.getElementById('transcriptBox');
            const insertText = document.getElementById('insertText');
          
            // Open modal
            if (speechButton) {
              speechButton.addEventListener('click', () => {
                speechModal.style.display = 'block';
              });
            }
            
            // Close modal
            if (closeButton) {
              closeButton.addEventListener('click', () => {
                speechModal.style.display = 'none';
              });
            }
          
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
              if (e.target === speechModal) {
                speechModal.style.display = 'none';
              }
            });
            
            // Start recording
            if (startRecord) {
              startRecord.addEventListener('click', async () => {
                try {
                  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                  mediaRecorder = new MediaRecorder(stream);
                  audioChunks = [];
                  
                  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                  mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const formData = new FormData();
                    formData.append('audio', audioBlob);
                    
                    startRecord.disabled = true;
                    stopRecord.disabled = true;
                    transcriptBox.textContent = "Processing your speech...";
                    
                    try {
                      // Get CSRF token from the form
                      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                      
                      // Send to Django backend
                      const response = await fetch('/transcribe/', {
                        method: 'POST',
                        body: formData,
                        headers: { "X-CSRFToken": csrfToken }
                      });
                      
                      if (response.ok) {
                        const transcript = await response.json();
                        transcriptBox.innerText = transcript.text || "No speech detected. Please try again.";
                      } else {
                        transcriptBox.innerText = "Error transcribing audio. Please try again.";
                      }
                    } catch (error) {
                      transcriptBox.innerText = "Error processing audio: " + error.message;
                      console.error('Error:', error);
                    } finally {
                      startRecord.disabled = false;
                      stopRecord.disabled = true;
                    }
                  };
                  
                  mediaRecorder.start();
                  startRecord.disabled = true;
                  stopRecord.disabled = false;
                  transcriptBox.textContent = "Recording... Speak now.";
                  
                  // Add recording indicator
                  const recordingStatus = document.createElement('div');
                  recordingStatus.id = 'recordingStatus';
                  recordingStatus.innerHTML = '<div class="recording-indicator"></div><span>Recording...</span>';
                  recordingStatus.style.display = 'flex';
                  recordingStatus.style.alignItems = 'center';
                  recordingStatus.style.marginTop = '10px';
                  recordingStatus.style.color = '#ff4d4f';
                  recordingStatus.style.fontWeight = 'bold';
                  
                  const recordingIndicator = recordingStatus.querySelector('.recording-indicator');
                  if (recordingIndicator) {
                    recordingIndicator.style.width = '12px';
                    recordingIndicator.style.height = '12px';
                    recordingIndicator.style.borderRadius = '50%';
                    recordingIndicator.style.backgroundColor = '#ff4d4f';
                    recordingIndicator.style.marginRight = '8px';
                    recordingIndicator.style.animation = 'pulse 1.5s infinite';
                  }
                  
                  // Add the status before the transcript box
                  transcriptBox.parentNode.insertBefore(recordingStatus, transcriptBox);
                } catch (error) {
                  console.error('Error accessing microphone:', error);
                  transcriptBox.textContent = "Error accessing microphone. Please check your browser permissions.";
                }
              });
            }
            
            // Stop recording
            if (stopRecord) {
              stopRecord.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                  mediaRecorder.stop();
                  
                  // Remove recording indicator
                  const recordingStatus = document.getElementById('recordingStatus');
                  if (recordingStatus) {
                    recordingStatus.remove();
                  }
                }
              });
            }
            
            // Insert transcribed text into note
            if (insertText) {
              insertText.addEventListener('click', () => {
                const noteContent = document.getElementById('normal');
                if (noteContent && transcriptBox.textContent.trim() !== '') {
                  // Insert at cursor position if possible
                  const selection = window.getSelection();
                  if (selection.rangeCount > 0 && noteContent.contains(selection.anchorNode)) {
                    const range = selection.getRangeAt(0);
                    const textNode = document.createTextNode(transcriptBox.textContent);
                    range.insertNode(textNode);
                  } else {
                    // Append to the end if no cursor position
                    noteContent.innerHTML += '\n' + transcriptBox.textContent;
                  }
                  
                  speechModal.style.display = 'none';
                  transcriptBox.textContent = '';
                }
              });
            }
          });
          
          // Handle theme selection with AJAX
          const themeOptions = document.querySelectorAll(".theme-option");
          if (themeOptions.length > 0) {
            const noteIdElement = document.getElementById('note-form');
            const noteId = noteIdElement ? noteIdElement.getAttribute('action').split('/').filter(Boolean).pop() : null;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : null;
          
            themeOptions.forEach((option) => {
              option.addEventListener("click", function() {
                const theme = this.getAttribute("data-theme");
                
                if (noteId && csrfToken) {
                  // Send AJAX request to Django backend
                  fetch(`/notes/${noteId}/change-theme/`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                      'X-CSRFToken': csrfToken
                    },
                    body: `theme=${theme}`
                  })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      // Update the UI with the new theme
                      const bgElement = document.querySelector(".bg");
                      if (bgElement) {
                        bgElement.setAttribute("data-theme", theme);
                        const themeDropdown = document.getElementById("theme-dropdown");
                        if (themeDropdown) {
                          themeDropdown.style.display = "none";
                        }
                      }
                    }
                  })
                  .catch(error => console.error('Error:', error));
                }
              });
            });
          }
          
          // Function to save content to hidden fields
          function saveContent() {
            var title = document.getElementById('title').innerHTML;
            document.getElementById('note-title').value = title;
          
            var content = document.getElementById('normal').innerHTML;
            document.getElementById('note-content').value = content;
          }
          
          // Function to change text color
          function changeTextColor(color) {
            document.execCommand('foreColor', false, color);
          }
          
          // Add keyframe animation for recording indicator
          const style = document.createElement('style');
          style.textContent = `
          @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
          }
          `;
          document.head.appendChild(style);
    </script>

</body>
</html>
